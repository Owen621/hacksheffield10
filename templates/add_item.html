{% extends "base.html" %}

{% block content %}
<h2>Add New Clothing Item</h2>

<form id="addForm" enctype="multipart/form-data">
    <input type="text" name="name" placeholder="Clothing name" required>
    <textarea name="description" placeholder="Description"></textarea>
    <input type="file" name="image_file" accept="image/*" required>
    <button type="submit" id="submitBtn">Add Item & Mint NFT</button>
</form>

<script>
document.getElementById("addForm").onsubmit = async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.textContent = "Minting NFT...";

    try {
        const walletPublicKey = "{{ wallet_public_key }}";
        if (!walletPublicKey) {
            alert("Please connect your wallet first!");
            submitBtn.disabled = false;
            submitBtn.textContent = "Add Item & Mint NFT";
            return;
        }

        const form = e.target;
        const formData = new FormData(form);
        formData.append("wallet_public_key", walletPublicKey);

        // POST to the correct endpoint: /add
        const resp = await fetch("/add", {
            method: "POST",
            body: formData
        });

        const result = await resp.json();

        if (!result.success) {
            throw new Error(result.error || "NFT minting failed");
        }

        alert(`NFT minted successfully! Explorer: ${result.explorer_url}`);
        window.location.href = `/item/${result.item_id}`;

    } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Add Item & Mint NFT";
    }
};
</script>
{% endblock %}
